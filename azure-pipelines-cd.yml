trigger: none
pr: none

resources:
  pipelines:
    - pipeline: ciPipeline
      source: Thivagar007.HTS-L2-CS001
      trigger: true

variables:
  - name: acrLoginServer
    value: htsl2cs01.azurecr.io
  - name: imageName
    value: snakegameapp
  - name: tag
    value: $(resources.pipeline.ciPipeline.runName)

stages:

- stage: Deploy_Dev
  displayName: 'Deploy to Dev'
  jobs:
    - deployment: DeployDev
      displayName: 'Deploy to AKS (Dev)'
      environment: 'dev'
      pool:
        name: 'vmss-agent'
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
                displayName: 'Checkout repository'
              - script: |
                  sed -i 's#__IMAGE_TAG__#$(tag)#g' deployment.yaml
                displayName: 'Inject image tag into manifest'

              - task: Kubernetes@1
                displayName: 'Deploy to AKS - Dev'
                inputs:
                  connectionType: 'Kubernetes Service Connection'
                  kubernetesServiceEndpoint: 'HTS-L2-AKS-SC'
                  namespace: 'dev'
                  command: apply
                  useConfigurationFile: true
                  configuration: |
                    deployment.yaml
                    service.yaml

- stage: Deploy_Test
  displayName: 'Deploy to Test'
  dependsOn: Deploy_Dev
  condition: succeeded()
  jobs:
    - deployment: DeployTest
      displayName: 'Deploy to AKS (Test)'
      environment: 'test'
      pool:
        name: 'vmss-agent'
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
                displayName: 'Checkout repository'
              - script: |
                  sed -i 's#__IMAGE_TAG__#$(tag)#g' deployment.yaml
                displayName: 'Inject image tag into manifest'

              - task: Kubernetes@1
                displayName: 'Deploy to AKS - Test'
                inputs:
                  connectionType: 'Kubernetes Service Connection'
                  kubernetesServiceEndpoint: 'HTS-L2-AKS-SC'
                  namespace: 'test'
                  command: apply
                  useConfigurationFile: true
                  configuration: |
                    deployment.yaml
                    service.yaml

- stage: Deploy_Prod
  displayName: 'Deploy to Prod'
  dependsOn: Deploy_Test
  condition: succeeded()
  jobs:
    - deployment: DeployProd
      displayName: 'Deploy to AKS (Prod)'
      environment: 'prod'
      pool:
        name: 'vmss-agent'
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
                displayName: 'Checkout repository'
              - script: |
                  sed -i 's#__IMAGE_TAG__#$(tag)#g' deployment.yaml
                displayName: 'Inject image tag into manifest'

              - task: Kubernetes@1
                displayName: 'Deploy to AKS - Prod'
                inputs:
                  connectionType: 'Kubernetes Service Connection'
                  kubernetesServiceEndpoint: 'HTS-L2-AKS-SC'
                  namespace: 'prod'
                  command: apply
                  useConfigurationFile: true
                  configuration: |
                    deployment.yaml
                    service.yaml